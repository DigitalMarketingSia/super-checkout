
import { useCallback } from 'react';
import { CustomerFormData } from '@/types/checkout';
import { useMercadoPagoPayment } from './useMercadoPagoPayment';
import { CheckoutConfig } from '@/api/mockDatabase';
import { OrderCalculationResult } from '@/core/checkoutEngine';

interface UsePixPaymentProps {
  checkout: CheckoutConfig | null;
  orderCalculation: OrderCalculationResult | null;
}

export const usePixPayment = ({ checkout, orderCalculation }: UsePixPaymentProps) => {
  const {
    processPixPayment: mpProcessPixPayment,
    isReady: mpReady
  } = useMercadoPagoPayment({ checkout, orderCalculation });

  const processPixPayment = useCallback(async (
    formData: CustomerFormData,
    items: any[],
    mpGateway: any
  ) => {
    console.log('üí∞ [PIX HOOK] Iniciando processamento PIX...', {
      hasFormData: !!formData,
      formFields: Object.keys(formData).filter(key => formData[key as keyof CustomerFormData]),
      mpReady,
      hasCheckout: !!checkout,
      hasOrderCalculation: !!orderCalculation,
      totalAmount: orderCalculation?.totalFinal,
      gatewayInfo: mpGateway ? {
        id: mpGateway.id,
        name: mpGateway.name,
        type: mpGateway.type,
        environment: mpGateway.environment
      } : 'Nenhum gateway fornecido'
    });
    
    // Valida√ß√µes b√°sicas mais robustas
    if (!formData.nome || !formData.email) {
      const missingFields = [];
      if (!formData.nome) missingFields.push('Nome');
      if (!formData.email) missingFields.push('Email');
      
      console.error('‚ùå [PIX HOOK] Dados obrigat√≥rios faltando:', {
        missingFields,
        formData: {
          nome: formData.nome ? 'PRESENTE' : 'AUSENTE',
          email: formData.email ? 'PRESENTE' : 'AUSENTE',
          telefone: formData.telefone ? 'PRESENTE' : 'AUSENTE',
          cpf: formData.cpf ? 'PRESENTE' : 'AUSENTE'
        }
      });
      throw new Error(`Preencha os seguintes campos obrigat√≥rios: ${missingFields.join(', ')}`);
    }
    
    // Verificar se temos gateway v√°lido
    if (!mpGateway) {
      console.error('‚ùå [PIX HOOK] Gateway MercadoPago n√£o fornecido');
      throw new Error('Gateway de pagamento n√£o configurado. Contate o suporte.');
    }
    
    // Verificar se MP est√° pronto, mas permitir fallback se tivermos credenciais diretas
    if (!mpReady) {
      console.warn('‚ö†Ô∏è [PIX HOOK] MP n√£o est√° pronto, tentando com credenciais diretas:', {
        mpReady,
        hasGateway: !!mpGateway,
        gatewayCredentials: mpGateway.credentials ? Object.keys(mpGateway.credentials) : []
      });
      
      // Se n√£o temos nem credenciais, √© erro mesmo
      if (!mpGateway.credentials || !mpGateway.credentials.accessTokenProd && !mpGateway.credentials.accessTokenSandbox) {
        console.error('‚ùå [PIX HOOK] Nem MP nem credenciais dispon√≠veis');
        throw new Error('Sistema de pagamento n√£o est√° configurado. Verifique as credenciais.');
      }
    }
    
    try {
      console.log('üîÑ [PIX HOOK] Chamando processamento via MercadoPago...');
      const result = await mpProcessPixPayment(formData, []);
      console.log('‚úÖ [PIX HOOK] Processamento conclu√≠do com sucesso');
      return result;
    } catch (error) {
      console.error('‚ùå [PIX HOOK] Erro no processamento:', {
        errorType: error instanceof Error ? error.constructor.name : typeof error,
        message: error instanceof Error ? error.message : String(error),
        formData: {
          nome: formData.nome ? 'PRESENTE' : 'AUSENTE',
          email: formData.email ? 'PRESENTE' : 'AUSENTE',
          telefone: formData.telefone ? 'PRESENTE' : 'AUSENTE',
          cpf: formData.cpf ? 'PRESENTE' : 'AUSENTE'
        },
        gatewayId: mpGateway?.id || 'N/A'
      });
      
      // Melhorar mensagens de erro para o usu√°rio
      if (error instanceof Error) {
        if (error.message.includes('credentials') || error.message.includes('gateway')) {
          throw new Error('Sistema de pagamento n√£o configurado. Contate o suporte.');
        } else if (error.message.includes('required') || error.message.includes('obrigat√≥rio')) {
          throw error; // Manter erro de valida√ß√£o original
        } else if (error.message.includes('amount') || error.message.includes('valor')) {
          throw new Error('Valor do pagamento inv√°lido. Tente novamente.');
        } else {
          throw new Error('Erro ao processar PIX. Tente novamente em alguns instantes.');
        }
      }
      
      throw new Error('Erro inesperado no processamento. Tente novamente.');
    }
  }, [mpReady, mpProcessPixPayment, checkout, orderCalculation]);

  return {
    processPixPayment
  };
};
