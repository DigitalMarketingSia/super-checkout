
import { useState, useEffect } from 'react';
import { CheckoutConfig } from '@/api/mockDatabase';

interface UseCheckoutDataProps {
  checkoutId: string | undefined;
  getCheckoutById: (id: string) => CheckoutConfig | undefined;
  getProductById: (id: string) => any;
  contextLoading: boolean;
}

export const useCheckoutData = ({
  checkoutId,
  getCheckoutById,
  getProductById,
  contextLoading
}: UseCheckoutDataProps) => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [checkout, setCheckout] = useState<CheckoutConfig | null>(null);
  const [mainProduct, setMainProduct] = useState<any>(null);
  const [orderBumps, setOrderBumps] = useState<any[]>([]);

  // Fun√ß√£o para normalizar requiredFormFields
  const normalizeRequiredFields = (fields: any): string[] => {
    console.log('üîß normalizeRequiredFields: Input recebido:', fields, typeof fields);
    
    if (Array.isArray(fields)) {
      console.log('‚úÖ normalizeRequiredFields: J√° √© array:', fields);
      return fields;
    }
    
    if (typeof fields === 'object' && fields !== null) {
      const normalized = Object.entries(fields)
        .filter(([_, value]) => value)
        .map(([key]) => key);
      console.log('üîÑ normalizeRequiredFields: Objeto convertido para array:', normalized);
      return normalized;
    }
    
    console.log('‚ö†Ô∏è normalizeRequiredFields: Retornando array vazio para:', fields);
    return [];
  };

  useEffect(() => {
    if (contextLoading) {
      console.log('‚è≥ Aguardando carregamento dos contextos...');
      return;
    }

    if (!checkoutId) {
      setError('ID do checkout n√£o fornecido');
      setLoading(false);
      return;
    }

    console.log('üîç Carregando dados do checkout:', checkoutId);

    try {
      const checkoutData = getCheckoutById(checkoutId);
      
      if (!checkoutData) {
        console.error('‚ùå Checkout n√£o encontrado:', checkoutId);
        setError('Checkout n√£o encontrado');
        setLoading(false);
        return;
      }

      console.log('‚úÖ Checkout encontrado:', checkoutData.name);
      
      // Garantir que gatewayId seja sempre string ou null e normalizar requiredFormFields
      const normalizedCheckout = {
        ...checkoutData,
        gatewayId: checkoutData.gatewayId || null,
        requiredFormFields: normalizeRequiredFields(checkoutData.requiredFormFields)
      };
      
      console.log('üîß Campos obrigat√≥rios normalizados:', normalizedCheckout.requiredFormFields);
      setCheckout(normalizedCheckout);

      // Carregar produto principal
      const product = getProductById(checkoutData.mainProductId);
      if (!product) {
        console.error('‚ùå Produto principal n√£o encontrado:', checkoutData.mainProductId);
        setError('Produto principal n√£o encontrado');
        setLoading(false);
        return;
      }

      console.log('‚úÖ Produto principal encontrado:', product.name);
      setMainProduct(product);

      // Carregar order bumps se existirem - usando propriedade correta
      const orderBumpIds = (checkoutData as any).orderBumps || (checkoutData as any).order_bumps || [];
      const bumps = orderBumpIds
        .map((bumpId: string) => getProductById(bumpId))
        .filter(Boolean);
      
      console.log('üéÅ Order bumps carregados:', bumps.length);
      setOrderBumps(bumps);

      setError(null);
    } catch (err) {
      console.error('‚ùå Erro ao carregar dados do checkout:', err);
      setError('Erro ao carregar dados do checkout');
    } finally {
      setLoading(false);
    }
  }, [checkoutId, getCheckoutById, getProductById, contextLoading]);

  return {
    loading,
    error,
    checkout,
    mainProduct,
    orderBumps
  };
};
