
import { useCallback, useState } from 'react';

interface UseMercadoPagoReactProps {
  credentials: {
    publicKeyProd?: string;
    accessTokenProd?: string;
    publicKeySandbox?: string;
    accessTokenSandbox?: string;
    // Legacy fields for backward compatibility
    publicKey?: string;
    accessToken?: string;
  };
  environment: 'sandbox' | 'production';
}

export const useMercadoPagoReact = ({ credentials, environment }: UseMercadoPagoReactProps) => {
  const [isSDKLoaded, setIsSDKLoaded] = useState(false);
  const [mpInstance, setMpInstance] = useState<any>(null);
  const [initializationAttempts, setInitializationAttempts] = useState(0);
  const maxRetries = 3;

  const getPublicKey = useCallback(() => {
    console.log('üîç Buscando public key para ambiente:', environment);
    console.log('üìã Credenciais dispon√≠veis:', Object.keys(credentials));

    let publicKey: string | null = null;

    if (environment === 'production') {
      publicKey = credentials.publicKeyProd || credentials.publicKey || null;
    } else {
      publicKey = credentials.publicKeySandbox || credentials.publicKey || null;
    }

    console.log('üîë Public key encontrada:', publicKey ? publicKey.substring(0, 20) + '...' : 'N√£o encontrada');
    return publicKey;
  }, [credentials, environment]);

  const getAccessToken = useCallback(() => {
    console.log('üîç Buscando access token para ambiente:', environment);
    
    let accessToken: string | null = null;

    if (environment === 'production') {
      accessToken = credentials.accessTokenProd || credentials.accessToken || null;
    } else {
      accessToken = credentials.accessTokenSandbox || credentials.accessToken || null;
    }

    console.log('üé´ Access token encontrado:', accessToken ? accessToken.substring(0, 20) + '...' : 'N√£o encontrado');
    return accessToken;
  }, [credentials, environment]);

  const isConfigured = useCallback(() => {
    const publicKey = getPublicKey();
    const accessToken = getAccessToken();
    const configured = !!(publicKey && accessToken);
    
    console.log('‚öôÔ∏è Gateway configurado:', configured, {
      hasPublicKey: !!publicKey,
      hasAccessToken: !!accessToken,
      environment
    });
    
    return configured;
  }, [getPublicKey, getAccessToken, environment]);

  const loadMercadoPagoSDK = useCallback(() => {
    return new Promise<void>((resolve, reject) => {
      // Verificar se SDK j√° est√° carregado
      if (window.MercadoPago) {
        console.log('‚úÖ SDK MercadoPago j√° estava carregado');
        setIsSDKLoaded(true);
        resolve();
        return;
      }

      // Verificar se j√° existe um script sendo carregado
      const existingScript = document.querySelector('script[src="https://sdk.mercadopago.com/js/v2"]');
      if (existingScript) {
        console.log('üîÑ Script MercadoPago j√° est√° sendo carregado, aguardando...');
        
        const checkSDK = setInterval(() => {
          if (window.MercadoPago) {
            console.log('‚úÖ SDK MercadoPago carregado via script existente');
            clearInterval(checkSDK);
            setIsSDKLoaded(true);
            resolve();
          }
        }, 100);

        // Timeout ap√≥s 10 segundos
        setTimeout(() => {
          clearInterval(checkSDK);
          reject(new Error('Timeout ao aguardar SDK do MercadoPago'));
        }, 10000);
        
        return;
      }

      console.log('üîÑ Carregando SDK MercadoPago...');
      const script = document.createElement('script');
      script.src = 'https://sdk.mercadopago.com/js/v2';
      script.async = true;
      
      script.onload = () => {
        console.log('‚úÖ SDK MercadoPago carregado com sucesso');
        setIsSDKLoaded(true);
        resolve();
      };
      
      script.onerror = (error) => {
        console.error('‚ùå Erro ao carregar SDK MercadoPago:', error);
        reject(new Error('Falha ao carregar SDK do MercadoPago'));
      };
      
      document.head.appendChild(script);
    });
  }, []);

  const initializeMercadoPago = useCallback(async () => {
    if (!isConfigured()) {
      const error = 'Credenciais do MercadoPago n√£o configuradas para o ambiente ' + environment;
      console.error('‚ùå', error);
      throw new Error(error);
    }

    const publicKey = getPublicKey();
    if (!publicKey) {
      const error = 'Public Key n√£o encontrada para ambiente ' + environment;
      console.error('‚ùå', error);
      throw new Error(error);
    }

    // Implementar retry logic
    const attemptInitialization = async (attempt: number): Promise<void> => {
      try {
        console.log(`üîÑ Tentativa ${attempt}/${maxRetries} - Inicializando MercadoPago...`);
        
        // Carregar SDK se necess√°rio
        await loadMercadoPagoSDK();

        // Aguardar um pouco para garantir que o SDK est√° dispon√≠vel
        await new Promise(resolve => setTimeout(resolve, 100));

        if (!window.MercadoPago) {
          throw new Error('SDK MercadoPago n√£o est√° dispon√≠vel ap√≥s carregamento');
        }

        // Inicializar com a public key
        console.log('üîë Inicializando MP com public key:', publicKey.substring(0, 20) + '...');
        console.log('üåç Ambiente:', environment);
        
        // Verificar se estamos no client side
        if (typeof window === 'undefined') {
          throw new Error('MercadoPago SDK s√≥ pode ser inicializado no client side');
        }
        
        const mp = new window.MercadoPago(publicKey, {
          locale: 'pt-BR'
        });
        
        console.log('‚úÖ MercadoPago inicializado com sucesso');
        console.log('üîß Inst√¢ncia MP criada:', typeof mp);
        console.log('üîß M√©todos dispon√≠veis:', Object.getOwnPropertyNames(mp));
        
        setMpInstance(mp);
        setIsSDKLoaded(true);
        setInitializationAttempts(0);
        
      } catch (error) {
        console.error(`‚ùå Tentativa ${attempt} falhou:`, error);
        
        if (attempt < maxRetries) {
          const delay = attempt * 1000; // Delay progressivo
          console.log(`‚è≥ Aguardando ${delay}ms antes da pr√≥xima tentativa...`);
          await new Promise(resolve => setTimeout(resolve, delay));
          return attemptInitialization(attempt + 1);
        } else {
          setInitializationAttempts(attempt);
          setIsSDKLoaded(false);
          throw new Error(`Falha ao inicializar MercadoPago ap√≥s ${maxRetries} tentativas: ${error}`);
        }
      }
    };

    return attemptInitialization(1);
  }, [isConfigured, getPublicKey, loadMercadoPagoSDK, environment, maxRetries]);

  return {
    initializeMercadoPago,
    getPublicKey,
    getAccessToken,
    isConfigured,
    isSDKLoaded,
    initializationAttempts,
    mpInstance
  };
};
