/**
 * AuthContext - Context de AutenticaÃ§Ã£o com Supabase
 * 
 * Gerencia o estado global de autenticaÃ§Ã£o da aplicaÃ§Ã£o usando Supabase Auth,
 * incluindo informaÃ§Ãµes do usuÃ¡rio logado e controle de sessÃ£o.
 * 
 * @context AuthContext
 * @description Context responsÃ¡vel por gerenciar a autenticaÃ§Ã£o real da aplicaÃ§Ã£o
 * usando Supabase Auth com tokens JWT, refresh automÃ¡tico e persistÃªncia de sessÃ£o.
 * 
 * @example
 * ```tsx
 * const { isLoggedIn, user, signIn, signOut, loading } = useAuth();
 * ```
 */

import React, { createContext, useContext, ReactNode } from 'react';
import { User } from '@supabase/supabase-js';
import { useSupabaseAuth } from '@/hooks/useSupabaseAuth';

interface AuthContextType {
  user: User | null;
  isAuthenticated: boolean;
  loading: boolean;
  signIn: (email: string, password: string) => Promise<{ data: any; error: any }>;
  signUp: (email: string, password: string) => Promise<{ data: any; error: any }>;
  signOut: () => Promise<{ error: any }>;
  // Legacy compatibility
  isLoggedIn: boolean;
  currentUserEmail: string | null;
  logout: () => void;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

/**
 * Hook para acessar o contexto de autenticaÃ§Ã£o
 * 
 * @returns {AuthContextType} Objeto com estado e mÃ©todos de autenticaÃ§Ã£o
 * @throws {Error} Se usado fora do AuthProvider
 */
export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

interface AuthProviderProps {
  children: ReactNode;
}

/**
 * AuthProvider Component
 * 
 * Provider do contexto de autenticaÃ§Ã£o que envolve a aplicaÃ§Ã£o e fornece
 * estado de autenticaÃ§Ã£o para todos os componentes filhos usando Supabase Auth.
 * 
 * @param {AuthProviderProps} props - Props do provider
 * @param {ReactNode} props.children - Componentes filhos
 * 
 * @returns {JSX.Element} Provider com contexto de autenticaÃ§Ã£o
 */
export const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {
  const auth = useSupabaseAuth();

  // Legacy logout function for backward compatibility
  const logout = async () => {
    console.log('ðŸšª Fazendo logout...');
    const { error } = await auth.signOut();
    if (!error) {
      window.location.href = '/login';
    }
  };

  const value: AuthContextType = {
    user: auth.user,
    isAuthenticated: auth.isAuthenticated,
    loading: auth.loading,
    signIn: auth.signIn,
    signUp: auth.signUp,
    signOut: auth.signOut,
    // Legacy compatibility
    isLoggedIn: auth.isAuthenticated,
    currentUserEmail: auth.user?.email || null,
    logout
  };

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  );
};