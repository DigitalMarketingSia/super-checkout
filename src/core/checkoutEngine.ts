
// CAMADA DE L√ìGICA DE NEG√ìCIO (O Motor - A F√°brica)
// Esta camada N√ÉO PODE TER NENHUMA IMPORTA√á√ÉO DO REACT
// Fun√ß√£o: Motor de c√°lculos que processa pedidos e aplica regras de neg√≥cio

export interface CartItem {
  id: string;
  name: string;
  price: number;
  type: 'main' | 'bump';
}

export interface OrderCalculationResult {
  subtotal: number;
  totalBumps: number;
  totalFinal: number;
  items: CartItem[];
  discounts?: number;
  taxes?: number;
  // Adicionando propriedades que estavam faltando
  valorProdutoPrincipal: number;
  orderBumps: CartItem[];
}

/**
 * Converte valor em reais para centavos (inteiros) para c√°lculos precisos
 */
const toCents = (reais: number): number => Math.round(reais * 100);

/**
 * Converte centavos de volta para reais
 */
const toReais = (centavos: number): number => centavos / 100;

/**
 * MOTOR DE C√ÅLCULO PRINCIPAL
 * Esta √© a fun√ß√£o central que processa um carrinho e retorna os totais calculados
 * REGRA DE OURO: Esta fun√ß√£o n√£o sabe nada sobre React ou componentes UI
 */
export const calculateOrder = (items: CartItem[]): OrderCalculationResult => {
  console.log('üè≠ Motor de C√°lculo: Processando pedido', items);
  
  // Separar produtos principais dos order bumps
  const mainProducts = items.filter(item => item.type === 'main');
  const orderBumps = items.filter(item => item.type === 'bump');
  
  // Calcular usando aritm√©tica de centavos para precis√£o
  const subtotalCents = mainProducts.reduce((total, item) => total + toCents(item.price), 0);
  const totalBumpsCents = orderBumps.reduce((total, item) => total + toCents(item.price), 0);
  
  // Converter de volta para reais
  const subtotal = toReais(subtotalCents);
  const totalBumps = toReais(totalBumpsCents);
  
  // REMOVIDO: Desconto autom√°tico oculto que estava causando o problema
  // Agora a soma √© exata: produto principal + order bumps
  let discounts = 0;
  
  // Calcular total final (soma exata)
  const totalFinalCents = subtotalCents + totalBumpsCents;
  const totalFinal = toReais(totalFinalCents);
  
  const result: OrderCalculationResult = {
    subtotal,
    totalBumps,
    totalFinal,
    items,
    discounts,
    // Novas propriedades
    valorProdutoPrincipal: subtotal,
    orderBumps
  };
  
  console.log('üí∞ Resultado do c√°lculo (corrigido):', result);
  console.log('üîç Verifica√ß√£o:', {
    subtotalCents,
    totalBumpsCents,
    totalFinalCents,
    'Soma em reais': subtotal + totalBumps,
    'Total final': totalFinal
  });
  
  return result;
};

/**
 * Fun√ß√£o auxiliar para validar se um item pode ser adicionado ao carrinho
 */
export const validateCartItem = (item: CartItem): boolean => {
  return item.price > 0 && item.name.length > 0 && item.id.length > 0;
};

/**
 * Fun√ß√£o para aplicar cupons de desconto (exemplo de extensibilidade)
 * IMPORTANTE: Descontos agora s√£o aplicados explicitamente via cupons
 */
export const applyCoupon = (calculation: OrderCalculationResult, couponCode: string): OrderCalculationResult => {
  const validCoupons: Record<string, number> = {
    'DESCONTO10': 0.1,
    'PROMO20': 0.2,
    'BLACKFRIDAY': 0.3
  };
  
  const discountPercent = validCoupons[couponCode.toUpperCase()];
  if (!discountPercent) {
    return calculation;
  }
  
  // Usar aritm√©tica de centavos para desconto preciso
  const totalCents = toCents(calculation.totalFinal);
  const couponDiscountCents = Math.round(totalCents * discountPercent);
  const newDiscountsCents = toCents(calculation.discounts || 0) + couponDiscountCents;
  const newTotalCents = totalCents - couponDiscountCents;
  
  return {
    ...calculation,
    discounts: toReais(newDiscountsCents),
    totalFinal: toReais(newTotalCents)
  };
};
